set -x
cp ub.json ~/vms/
mdbci generate ub --template ub.json --override
mdbci up ub
user=`mdbci ssh --command 'whoami' --silent ub`
ip=`mdbci show network --silent ub`
key=`mdbci show keyfile --silent ub`
me=`whoami`
sshopt="-o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no -o ConnectTimeout=120  "
ssh -i $key $sshopt $user@$ip "sudo adduser --disabled-password --gecos \"\" $me"
ssh -i $key $sshopt $user@$ip "sudo usermod -aG sudo $me"
ssh -i $key $sshopt $user@$ip "sudo usermod -aG google-sudoers $me"
ssh -i $key $sshopt $user@$ip "sudo cp -r /home/$user/.ssh /home/$me/"
ssh -i $key $sshopt $user@$ip "sudo chown $me:$me /home/$me/.ssh"
ssh -i $key $sshopt $user@$ip "sudo chown $me:$me /home/$me/.ssh/authorized_keys"
scp -i $key $sshopt -r MaxScale $me@$ip:/home/$me/

ssh -i $key $sshopt $me@$ip "mkdir .ssh; mkdir ub_vms; mkdir mdbci"
scp -i $key $sshopt max-tst.key $me@$ip:/home/$me/.ssh/id_rsa
ssh -i $key $sshopt $me@$ip "chmod 400 /home/$me/.ssh/id_rsa"
scp -i $key $sshopt mdbci_wrapper $me@$ip:/home/$me/mdbci/mdbci
ssh -i $key $sshopt $me@$ip "chmod +x /home/$me/mdbci/mdbci"
rm -rf ub_vms
mkdir ub_vms



#ssh -i $key $user@$ip ./MaxScale/BUILD/install_test_build_deps.sh
#ssh -i $key $user@$ip box=centos_7_gcp backend_box=centos_7_gcp $user@$ip./MaxScale/maxscale-system-test/mdbci/run_test.sh

